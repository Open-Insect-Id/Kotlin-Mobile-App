name: Build & Pre-Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Extract versionName
        id: version
        run: |
          VER=$(./gradlew :app:printVersionName --console=plain | grep "VERSION_NAME" | cut -d'=' -f2 | tr -d '[:space:]')
          echo "versionName=$VER" >> $GITHUB_ENV

      - name: Decode keystore
        run: echo "${{ secrets.KEYSTORE_FILE_B64 }}" | base64 -d > my-release-key.jks

      - name: Export signing env
        run: |
          echo "KEYSTORE_FILE=$PWD/my-release-key.jks" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Build APKs with retry
        run: |
          for i in {1..3}; do
            if ./gradlew assembleRelease assembleUnminifiedRelease assembleDebuggableRelease; then
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done
          exit 1

      - name: Rename APKs
        run: |
          MIN="OpenInsectId-v${{ env.versionName }}-beta-${{ github.run_number }}.apk"
          UNMIN="OpenInsectId-v${{ env.versionName }}-beta-${{ github.run_number }}-unminified.apk"
          DEBUG="OpenInsectId-v${{ env.versionName }}-beta-${{ github.run_number }}-debuggable.apk"
          
          mv app/build/outputs/apk/release/app-release.apk "$MIN"
          mv app/build/outputs/apk/unminifiedRelease/app-unminifiedRelease.apk "$UNMIN"
          mv app/build/outputs/apk/debuggableRelease/app-debuggableRelease.apk "$DEBUG"
          
          echo "APK_MIN=$MIN" >> $GITHUB_ENV
          echo "APK_UNMIN=$UNMIN" >> $GITHUB_ENV
          echo "APK_DEBUG=$DEBUG" >> $GITHUB_ENV

      - name: Create tag
        run: |
          TAG="v${{ env.versionName }}-beta-${{ github.run_number }}"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Release APKs
        run: |
          gh release create "${{ env.TAG_NAME }}" \
            "${{ env.APK_MIN }}" \
            "${{ env.APK_UNMIN }}" \
            "${{ env.APK_DEBUG }}" \
            --title "v${{ env.versionName }}-beta-${{ github.run_number }}" \
            --generate-notes \
            --prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
